<?php
session_start();
if(isset($_POST['submit'])) {
  $mysqli = new mysqli("db", "root", "root", "exploitable");
  if(mysqli_connect_errno()) {
    printf("Connect to database failed: %s\n", mysqli_connect_error());
    exit();
  }

  $username = $_POST['username'];
  $password = hash('sha256', $_POST['password']);

  $result = $mysqli->query("SELECT * FROM users WHERE (username LIKE '$username')");

  if($result->num_rows > 0) {
    $result = $mysqli->query("SELECT * FROM users WHERE (username LIKE '$username') AND (password = '$password')");
    if($result->num_rows > 0) {
      while($row = $result->fetch_assoc()) {
        if($row['admin'] == 1) {
          $_SESSION['admin'] = true;
          header('Location: /admin');
        } else {
          $_SESSION['admin'] = false;
        }
      }
    } else {
      $wrong_password = true;
    }
  } else {
    $wrong_user = true;
  }
  $mysqli->close();
}
?>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Administration Login</title>

    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/css/signin.css" rel="stylesheet">
  </head>

  <body class="text-center">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <form class="form-signin" method="POST" action="">
            <h1 class="h3 mb-3 font-weight-normal">Administration</h1>
            <label for="inputUsername" class="sr-only">Username</label>
            <input type="text" id="inputUsername" name="username" class="form-control" placeholder="Username" required autofocus>
            <label for="inputPassword" class="sr-only">Password</label>
            <input type="password" id="inputPassword" name="password" class="form-control" placeholder="Password" required>
            <input class="btn btn-lg btn-primary btn-block" type="submit" name="submit" value="Login">
            <p class="mt-5 mb-3 text-muted">&copy; 2018-2019</p>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
<?php
if(isset($_SESSION['admin'])) {
  if($_SESSION['admin'] == false) {
    echo '<p>Only admins can login!</p>';
  }
}

if($wrong_password == true) {
  echo '<p>Password for user ' . $username . ' is not correct!</p>';
}

if($wrong_user == true) {
  echo '<p>User not found!</p>';
}
?>
        </div>
      </div>
    </div>
  </body>
</html>
